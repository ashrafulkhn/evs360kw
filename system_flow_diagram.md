
# System Flow Diagrams

## High-Level Architecture
```
┌───────────────────────────────────────────────────────────────┐
│                       EV Charging System                       │
│                                                               │
│  ┌─────────┐        ┌───────────┐        ┌────────────────┐   │
│  │ Devices │◄─────► │ MQTT      │◄─────► │ Core Control   │   │
│  │ D1-D3   │        │ Interface │        │ System         │   │
│  └─────────┘        └───────────┘        └────────────────┘   │
│                                                  │            │
│                          ┌───────────────────────┼────────┐   │
│                          │                       │        │   │
│                ┌─────────▼─────┐       ┌─────────▼─────┐  │   │
│                │ Power Module  │       │ Gun Control   │  │   │
│                │ Management    │◄─────►│ Systems      │  │   │
│                └───────────────┘       └───────────────┘  │   │
│                          │                     │          │   │
│                          │      ┌──────────────┘          │   │
│                          │      │                         │   │
│                ┌─────────▼──────▼───┐    ┌───────────────▼───┐│
│                │ Power Allocation  │    │ Configuration     ││
│                │ Logic             │    │ Management        ││
│                └───────────────────┘    └───────────────────┘│
└───────────────────────────────────────────────────────────────┘
```

## Message Processing Flow
```
┌─────────┐     ┌──────────────┐     ┌────────────┐     ┌────────────────┐
│MQTT     │     │Topic:         │     │Message     │     │Gun Object      │
│Message  │────▶│vesec/gun_id/  │────▶│Processor   │────▶│Updates         │
│Received │     │msg_type/device│     │            │     │                │
└─────────┘     └──────────────┘     └────────────┘     └────────┬───────┘
                                                                  │
               ┌────────────────────────────────────────────────┐ │
               │ If message_type == "demand"                    │ │
               └────────────────────────────────────────────────┘ │
                                                                  ▼
                                                         ┌────────────────┐
                                                         │Demand Processor│
                                                         └────────┬───────┘
                                                                  │
                                                                  ▼
                                                         ┌────────────────┐
                                                         │Calculate needed│
                                                         │power modules   │
                                                         └────────┬───────┘
                                                                  │
                                  ┌─────────────────────┬─────────┘
                                  │                     │
                         ┌────────▼─────────┐  ┌────────▼─────────┐
                         │Activate needed   │  │Connect gun to    │
                         │power modules     │  │assigned modules  │
                         └──────────────────┘  └──────────────────┘
```

## Power Assignment Algorithm
```
┌─────────────────────────────┐
│ Start Power Assignment      │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Sort guns by demand         │
│ (highest first)             │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ For each gun with demand > 0 │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Apply max power cap from    │
│ configuration               │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Calculate modules needed    │
│ based on module capacity    │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Assign available modules    │
│ to gun                      │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Mark modules as assigned    │
└──────────────┬──────────────┘
               ▼
┌─────────────────────────────┐
│ Next gun                    │───┐
└──────────────┬──────────────┘   │
               │                  │
               │                  │
               ▼                  │
┌─────────────────────────────┐   │
│ Activate assigned modules   │   │
└──────────────┬──────────────┘   │
               │                  │
               ▼                  │
┌─────────────────────────────┐   │
│ Connect guns to their       │   │
│ assigned modules            │   │
└──────────────┬──────────────┘   │
               │                  │
               ▼                  │
┌─────────────────────────────┐   │
│ End Power Assignment        │◄──┘
└─────────────────────────────┘
```

## Device-to-Gun Mapping
```
┌─────────┐               ┌─────────┐
│ Device  │               │  Guns   │
└─────────┘               └─────────┘
    D1      ┌───────┐        Gun 1
    │       │       │────────┐
    │       │       │        │
    ├───────► Gun ID│        │
    │       │   1   │────────┘
    │       │       │
    │       │       │        Gun 2
    │       │       │────────┐
    └───────► Gun ID│        │
            │   2   │────────┘
            └───────┘

            ┌───────┐        Gun 3
    D2      │       │────────┐
    │       │       │        │
    ├───────► Gun ID│        │
    │       │   1   │────────┘
    │       │       │
    │       │       │        Gun 4
    │       │       │────────┐
    └───────► Gun ID│        │
            │   2   │────────┘
            └───────┘

            ┌───────┐        Gun 5
    D3      │       │────────┐
    │       │       │        │
    ├───────► Gun ID│        │
    │       │   1   │────────┘
    │       │       │
    │       │       │        Gun 6
    │       │       │────────┐
    └───────► Gun ID│        │
            │   2   │────────┘
            └───────┘
```

## Module-to-Gun Connection
```
┌─────────────┐           ┌────────────┐
│ Power       │           │ Guns       │
│ Modules     │           │            │
└─────────────┘           └────────────┘
    Module 1    ┌─────┐      Gun 1
    │           │     │───────┐
    │           │  C  │       │
    └───────────►  O  │       │
                │  N  │       │
    Module 2    │  T  │       │
    │           │  A  │───────┘
    │           │  C  │
    └───────────►  T  │
                │  O  │      Gun 2
    Module 3    │  R  │───────┐
    │           │  S  │       │
    │           │     │       │
    └───────────►     │       │
                │     │       │
    Module 4    │     │───────┘
    │           │     │
    │           │     │
    └───────────►     │      Gun 3
                │     │───────┐
    Module 5    │     │       │
    │           │     │       │
    │           │     │       │
    └───────────►     │       │
                │     │       │
                └─────┘───────┘
                   ⋮        ⋮
```
